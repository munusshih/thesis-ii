---
import ResourceCard from "./ResourceCard.astro";
import resourcesData from "../data/resources.json";
import manifest from "../data/resources.manifest.json";

const manifestEntries = Array.isArray(manifest)
  ? new Map(manifest.map((entry) => [entry.slug, entry]))
  : new Map();
const tabs = Array.isArray(resourcesData?.tabs) ? resourcesData.tabs : [];

const enhancedTabs = tabs.map((tab) => ({
  ...tab,
  items: Array.isArray(tab.items)
    ? tab.items.map((item) => {
        const manifestEntry = manifestEntries.get(item.slug);
        return {
          ...item,
          image: manifestEntry?.image ?? null,
          capturedAt: manifestEntry?.capturedAt ?? null,
          error: manifestEntry?.error ?? null,
          note: manifestEntry?.note ?? null,
          previewType: manifestEntry?.previewType ?? null,
        };
      })
    : [],
}));

// Flatten all items from all tabs and randomize
const allItems = enhancedTabs.flatMap((tab) =>
  tab.items.map((item) => ({ ...item, tabName: tab.name }))
);

// Shuffle function using Fisher-Yates algorithm
function shuffleArray<T>(array: T[]): T[] {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

const randomizedItems = shuffleArray(allItems);
---

{
  randomizedItems.length === 0 ? (
    <p class="resources__empty">No resources have been added yet.</p>
  ) : (
    randomizedItems.map((item) => (
      <ResourceCard {...item} tabName={item.tabName} />
    ))
  )
}

<style>
  .resources {
    display: grid;
    gap: 2.5rem;
  }

  .resources__intro {
    display: grid;
    gap: 0.75rem;
  }

  .resources__intro h2 {
    margin: 0;
    font-weight: 600;
    font-size: clamp(1.7rem, 2vw, 2.4rem);
  }

  .resources__intro p {
    margin: 0;
    max-width: 56ch;
    color: color-mix(in srgb, currentColor 65%, transparent);
  }

  .resources__section {
    display: grid;
    gap: 1.5rem;
  }

  .resources__section-header {
    display: flex;
    align-items: baseline;
    gap: 0.75rem;
  }

  .resources__section-header h3 {
    margin: 0;
    font-weight: 600;
    font-size: clamp(1.3rem, 1.5vw, 1.6rem);
  }

  .resources__count {
    color: color-mix(in srgb, currentColor 55%, transparent);
    font-size: 0.8rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
  }

  .resources__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(18rem, 1fr));
    gap: 1.75rem;
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .resources__grid li {
    height: 100%;
  }

  .resources__empty {
    margin: 0;
    color: color-mix(in srgb, currentColor 65%, transparent);
    font-style: italic;
  }
</style>
