---
import StudentWebsite from "./StudentWebsite.astro";
import students from "../data/students.json";
import manifest from "../data/student-websites.manifest.json";
import thesisProgress from "../data/thesis-progress.json";
import studentWork from "../data/student-work.json";
import nameMapping from "../data/student-name-mapping.json";
import { slugify } from "../utils/slug.js";

const manifestEntries = new Map(manifest.map((entry) => [entry.slug, entry]));
const progressEntries = new Map(
  thesisProgress.students.map((entry) => [entry.name.toLowerCase(), entry])
);
const workEntries = new Map(
  studentWork.students.map((entry) => [entry.name, entry])
);

// Helper function to normalize work entry names and merge duplicates
const mergedWorkEntries = new Map();
for (const [name, data] of workEntries) {
  // Extract the actual student name - if it contains " - ", take the part after it
  let normalizedName = name;
  if (name.includes(" - ")) {
    const parts = name.split(" - ");
    normalizedName = parts[parts.length - 1]; // Take the last part
  }
  
  // If this normalized name already exists, merge the work
  if (mergedWorkEntries.has(normalizedName)) {
    const existing = mergedWorkEntries.get(normalizedName);
    existing.images = [...(existing.images || []), ...(data.images || [])];
    existing.videos = [...(existing.videos || []), ...(data.videos || [])];
    existing.totalFiles = existing.images.length + existing.videos.length;
  } else {
    mergedWorkEntries.set(normalizedName, data);
  }
}

const studentEntries = students.map((student) => {
  const slug = slugify(student.name);
  const manifestEntry = manifestEntries.get(slug);

  // Try to match by first name, then by last name (case-insensitive)
  const nameParts = student.name.split(" ");
  const firstName = nameParts[0].toLowerCase();
  const lastName = nameParts[nameParts.length - 1].toLowerCase();

  let progressEntry = progressEntries.get(firstName);
  if (!progressEntry) {
    progressEntry = progressEntries.get(lastName);
  }
  
  // Also check if this student is a work folder name that maps to a display name
  // and try looking up by the display name
  if (!progressEntry) {
    const mapping = nameMapping.mappings.find(m => m.workFolderName === student.name);
    if (mapping) {
      const displayNameParts = mapping.displayName.split(" ");
      const displayFirstName = displayNameParts[0].toLowerCase();
      const displayLastName = displayNameParts[displayNameParts.length - 1].toLowerCase();
      progressEntry = progressEntries.get(displayFirstName) || progressEntries.get(displayLastName);
    }
  }

  const workEntry = mergedWorkEntries.get(student.name);

  return {
    ...student,
    slug,
    image: manifestEntry?.image ?? null,
    capturedAt: manifestEntry?.capturedAt ?? null,
    error: manifestEntry?.error ?? null,
    note: manifestEntry?.note ?? null,
    previewType: manifestEntry?.previewType ?? null,
    progress: progressEntry ?? null,
    work: workEntry ?? null,
  };
});
---

{
  studentEntries.map((student) => (
    <div class="student-item card student-directory" id={student.slug}>
      <StudentWebsite {...student} />
    </div>
  ))
}
