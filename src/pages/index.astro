---
import Footer from "@/components/Footer.astro";
import P5Sketch from "@/components/P5Sketch.astro";
import QuickLinks from "@/components/QuickLinks.astro";
import FadeIn from "@/components/FadeIn.astro";
import Analytics from "@vercel/analytics/astro";
import CourseInfo from "@/components/CourseInfo.astro";
import BodyLayout from "@/layouts/BodyLayout.astro";

import { SITE_DESCRIPTION, SITE_TITLE } from "@/consts";
import { getCollection } from "astro:content";

import { marked } from "marked";

const weeksRaw = await getCollection("weeks");
const weeks = weeksRaw.map((week) => ({
  ...week,
  html: marked.parse(week.body),
}));

// Find the latest week (highest week number)
const sortedWeeks = weeks.sort((a, b) => a.data.week - b.data.week);
const latestWeek = sortedWeeks[sortedWeeks.length - 1];
---

<BodyLayout title={SITE_TITLE} description={SITE_DESCRIPTION}>
  <header class="col-span-1 fade-in">
    <h1 class="text-3xl font-bold text-pretty">{SITE_TITLE}</h1>
    <P5Sketch />
    <CourseInfo />
  </header>

  <main class="column-container pb-10 fade-in">
    <QuickLinks />

    <section class="my-20">
      {
        sortedWeeks.map((week) => (
          <article class="weekly-content">
            <h3 class="weekly-title mb-10">
              <span>Week {week.data.week}:</span>
              <span>
                {week.data.title} ({week.data.date})
              </span>
            </h3>
            <div class="px-4 max-w-prose mx-auto w-full" set:html={week.html} />
          </article>
        ))
      }
    </section>

    <Footer />
  </main>
  <FadeIn />
  <Analytics />

  <script>
    // Make all links open in new tabs
    document.addEventListener("DOMContentLoaded", () => {
      const links = document.querySelectorAll("a[href]");
      links.forEach((link) => {
        if (!link.getAttribute("target")) {
          link.setAttribute("target", "_blank");
          link.setAttribute("rel", "noopener noreferrer");
        }
      });

      const titleSpans = document.querySelectorAll(".weekly-title span");
      const angles = [-8, -5, -3, -1.5, 1.5, 3, 5, 8];
      let lastAngle = null;
      titleSpans.forEach((span) => {
        let angle = angles[Math.floor(Math.random() * angles.length)];
        if (angle === lastAngle) {
          angle = angles[(angles.indexOf(angle) + 1) % angles.length];
        }
        lastAngle = angle;
        span.style.transform = `rotate(${angle}deg)`;
      });
    });
  </script>

  <style>
    .column-container > .column-block {
      break-inside: avoid;
      margin-bottom: 1.5rem;
    }

    .column-container > .column-block:last-child {
      margin-bottom: 0;
    }
  </style>
</BodyLayout>
