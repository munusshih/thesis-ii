---
import Footer from "@/components/Footer.astro";
import P5Sketch from "@/components/P5Sketch.astro";
import QuickLinks from "@/components/QuickLinks.astro";
import FadeIn from "@/components/FadeIn.astro";
import Analytics from "@vercel/analytics/astro";
import CourseInfo from "@/components/CourseInfo.astro";
import BodyLayout from "@/layouts/BodyLayout.astro";

import { SITE_DESCRIPTION, SITE_TITLE } from "@/consts";
import { getCollection } from "astro:content";

import { marked } from "marked";

const weeksRaw = await getCollection("weeks");
const weeks = weeksRaw.map((week) => ({
  ...week,
  html: marked.parse(week.body),
}));

// Find the latest week (highest week number)
const sortedWeeks = weeks.sort((a, b) => a.data.week - b.data.week);
const latestWeek = sortedWeeks[sortedWeeks.length - 1];
---

<BodyLayout title={SITE_TITLE} description={SITE_DESCRIPTION}>
  <header class="col-span-1 fade-in">
    <h1 class="text-3xl font-bold text-pretty">{SITE_TITLE}</h1>
    <P5Sketch />
    <CourseInfo />
  </header>

  <main class="column-container pb-10 fade-in">
    <QuickLinks />

    {
      sortedWeeks.map((week) => (
        <details
          class="week-post card"
          open={week.data.week === latestWeek.data.week}
        >
          <summary class="flex flex-col cursor-pointer">
            <h3>
              Week {week.data.week}: {week.data.title} ({week.data.date})
            </h3>
          </summary>
          <div class="pl-4 max-w-prose" set:html={week.html} />
        </details>
      ))
    }

    <Footer />
  </main>
  <FadeIn />
  <Analytics />

  <script>
    // Make all links open in new tabs
    document.addEventListener("DOMContentLoaded", () => {
      const links = document.querySelectorAll("a[href]");
      links.forEach((link) => {
        if (!link.getAttribute("target")) {
          link.setAttribute("target", "_blank");
          link.setAttribute("rel", "noopener noreferrer");
        }
      });
    });
  </script>

  <style>
    .column-container > .column-block {
      break-inside: avoid;
      margin-bottom: 1.5rem;
    }

    .column-container > .column-block:last-child {
      margin-bottom: 0;
    }
  </style>
</BodyLayout>
